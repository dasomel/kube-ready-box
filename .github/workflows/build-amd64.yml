name: Build AMD64 Vagrant Boxes

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Box version (e.g., 0.1.0)'
        required: false
        type: string
        default: ''
      publish:
        description: 'Publish to Vagrant Cloud'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  PACKER_VERSION: '1.10.0'

jobs:
  build-virtualbox:
    name: Build VirtualBox AMD64
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Install VirtualBox
        run: |
          # Add Oracle VirtualBox repository
          wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
          echo "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian $(lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list

          sudo apt-get update
          sudo apt-get install -y virtualbox-7.0

          # Verify installation
          VBoxManage --version

      - name: Packer Init
        working-directory: packer
        run: packer init .

      - name: Packer Validate
        working-directory: packer
        run: packer validate -only='virtualbox-iso.ubuntu-vbox-amd64' .

      - name: Packer Build
        working-directory: packer
        run: |
          packer build -only='virtualbox-iso.ubuntu-vbox-amd64' \
            -var 'headless=true' \
            .

      - name: Verify Box File
        run: |
          ls -lh packer/output-vagrant/ubuntu-24.04-virtualbox-amd64.box
          # Validate box structure
          tar -tzf packer/output-vagrant/ubuntu-24.04-virtualbox-amd64.box | head -10

      - name: Upload Box Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-virtualbox-amd64
          path: packer/output-vagrant/ubuntu-24.04-virtualbox-amd64.box
          retention-days: 7
          compression-level: 0  # Already compressed

      - name: Cleanup
        if: always()
        run: |
          rm -rf packer/output-*
          VBoxManage list vms | grep -oP '(?<=\")[^\"]+(?=\")' | xargs -I {} VBoxManage unregistervm "{}" --delete 2>/dev/null || true

  publish:
    name: Publish to Vagrant Cloud
    needs: build-virtualbox
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && inputs.publish == true)

    # Production environment with protection rules
    environment: production

    steps:
      - name: Download Box Artifact
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-24.04-virtualbox-amd64
          path: ./boxes

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Extract version from tag (v1.0.0 -> 1.0.0)
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
          else
            # Default version based on date
            echo "version=$(date +%Y.%m.%d)" >> $GITHUB_OUTPUT
          fi

      - name: Setup Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vagrant

      - name: Check if Version Exists
        id: check_version
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          if vagrant cloud search dasomel/ubuntu-24.04 --json 2>/dev/null | grep -q "\"version\":\"${{ steps.version.outputs.version }}\""; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish VirtualBox Box (New Version)
        if: steps.check_version.outputs.exists == 'false'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          vagrant cloud publish dasomel/ubuntu-24.04 \
            ${{ steps.version.outputs.version }} \
            virtualbox \
            boxes/ubuntu-24.04-virtualbox-amd64.box \
            --architecture amd64 \
            --version-description "Kubernetes-ready Ubuntu 24.04 LTS

## Features
- Ubuntu 24.04 LTS with OS optimizations for K8s
- Multi-architecture support (AMD64, ARM64)
- Multi-provider support (VirtualBox, VMware)
- Kernel tuning, resource limits, swap disabled
- Disk I/O and network optimizations

## Documentation
https://github.com/dasomel/kube-ready-box" \
            --release \
            --short-description "Kubernetes-ready Ubuntu 24.04 LTS Vagrant Box with OS-level optimizations"

      - name: Add VirtualBox Provider (Existing Version)
        if: steps.check_version.outputs.exists == 'true'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          # Create provider
          vagrant cloud provider create dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} virtualbox \
            --architecture amd64 2>/dev/null || echo "Provider already exists"

          # Upload box file
          vagrant cloud provider upload dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} virtualbox \
            amd64 boxes/ubuntu-24.04-virtualbox-amd64.box
