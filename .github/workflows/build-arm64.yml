name: Build ARM64 Vagrant Boxes

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Box version (e.g., 1.0.0)'
        required: false
        type: string
        default: ''
      provider:
        description: 'Provider to build'
        required: true
        type: choice
        options:
          - vmware
          - virtualbox
          - both
        default: vmware
      publish:
        description: 'Publish to Vagrant Cloud'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

env:
  PACKER_VERSION: '1.10.0'

jobs:
  build-vmware-arm64:
    name: Build VMware ARM64
    # Requires self-hosted ARM64 macOS runner
    runs-on: [self-hosted, macOS, ARM64]
    if: inputs.provider == 'vmware' || inputs.provider == 'both'
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Verify VMware Fusion
        run: |
          /Applications/VMware\ Fusion.app/Contents/Library/vmrun -T fusion list || echo "VMware Fusion check"

      - name: Packer Init
        working-directory: packer
        run: packer init .

      - name: Packer Validate
        working-directory: packer
        run: packer validate -only='vmware-iso.ubuntu-vmware-arm64' .

      - name: Packer Build
        working-directory: packer
        run: |
          packer build -only='vmware-iso.ubuntu-vmware-arm64' \
            -var 'headless=true' \
            .

      - name: Verify Box File
        run: |
          ls -lh packer/output-vagrant/ubuntu-24.04-vmware-arm64.box

      - name: Upload Box Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-vmware-arm64
          path: packer/output-vagrant/ubuntu-24.04-vmware-arm64.box
          retention-days: 7
          compression-level: 0

      - name: Cleanup
        if: always()
        run: |
          rm -rf packer/output-*

  build-virtualbox-arm64:
    name: Build VirtualBox ARM64
    # Requires self-hosted ARM64 macOS runner
    runs-on: [self-hosted, macOS, ARM64]
    if: inputs.provider == 'virtualbox' || inputs.provider == 'both'
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Verify VirtualBox
        run: |
          VBoxManage --version

      - name: Packer Init
        working-directory: packer
        run: packer init .

      - name: Packer Validate
        working-directory: packer
        run: packer validate -only='virtualbox-iso.ubuntu-vbox-arm64' .

      - name: Packer Build
        working-directory: packer
        run: |
          packer build -only='virtualbox-iso.ubuntu-vbox-arm64' \
            -var 'headless=true' \
            .

      - name: Verify Box File
        run: |
          ls -lh packer/output-vagrant/ubuntu-24.04-virtualbox-arm64.box

      - name: Upload Box Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-24.04-virtualbox-arm64
          path: packer/output-vagrant/ubuntu-24.04-virtualbox-arm64.box
          retention-days: 7
          compression-level: 0

      - name: Cleanup
        if: always()
        run: |
          rm -rf packer/output-*
          VBoxManage list vms | grep -oE '"[^"]+"' | tr -d '"' | xargs -I {} VBoxManage unregistervm "{}" --delete 2>/dev/null || true

  publish:
    name: Publish to Vagrant Cloud
    needs: [build-vmware-arm64, build-virtualbox-arm64]
    runs-on: ubuntu-latest
    if: |
      always() &&
      inputs.publish == true &&
      (needs.build-vmware-arm64.result == 'success' || needs.build-virtualbox-arm64.result == 'success')

    environment: production

    steps:
      - name: Download VMware Box
        if: needs.build-vmware-arm64.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-24.04-vmware-arm64
          path: ./boxes

      - name: Download VirtualBox Box
        if: needs.build-virtualbox-arm64.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ubuntu-24.04-virtualbox-arm64
          path: ./boxes

      - name: Get Version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +%Y.%m.%d)" >> $GITHUB_OUTPUT
          fi

      - name: Setup Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vagrant

      - name: Check if Version Exists
        id: check_version
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          if vagrant cloud search dasomel/ubuntu-24.04 --json 2>/dev/null | grep -q "\"version\":\"${{ steps.version.outputs.version }}\""; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish VMware Box (New Version)
        if: needs.build-vmware-arm64.result == 'success' && steps.check_version.outputs.exists == 'false'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          vagrant cloud publish dasomel/ubuntu-24.04 \
            ${{ steps.version.outputs.version }} \
            vmware_desktop \
            boxes/ubuntu-24.04-vmware-arm64.box \
            --architecture arm64 \
            --version-description "Kubernetes-ready Ubuntu 24.04 LTS

## Features
- Ubuntu 24.04 LTS with OS optimizations for K8s
- Multi-architecture support (AMD64, ARM64)
- Multi-provider support (VirtualBox, VMware)
- Kernel tuning, resource limits, swap disabled
- Disk I/O and network optimizations

## Documentation
https://github.com/dasomel/kube-ready-box" \
            --release \
            --short-description "Kubernetes-ready Ubuntu 24.04 LTS Vagrant Box with OS-level optimizations"

      - name: Publish VirtualBox Box (New Version)
        if: needs.build-virtualbox-arm64.result == 'success' && needs.build-vmware-arm64.result != 'success' && steps.check_version.outputs.exists == 'false'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          vagrant cloud publish dasomel/ubuntu-24.04 \
            ${{ steps.version.outputs.version }} \
            virtualbox \
            boxes/ubuntu-24.04-virtualbox-arm64.box \
            --architecture arm64 \
            --version-description "Kubernetes-ready Ubuntu 24.04 LTS

## Features
- Ubuntu 24.04 LTS with OS optimizations for K8s
- Multi-architecture support (AMD64, ARM64)
- Multi-provider support (VirtualBox, VMware)
- Kernel tuning, resource limits, swap disabled
- Disk I/O and network optimizations

## Documentation
https://github.com/dasomel/kube-ready-box" \
            --release \
            --short-description "Kubernetes-ready Ubuntu 24.04 LTS Vagrant Box with OS-level optimizations"

      - name: Add VMware Provider (Existing Version)
        if: needs.build-vmware-arm64.result == 'success' && steps.check_version.outputs.exists == 'true'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          vagrant cloud provider create dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} vmware_desktop \
            --architecture arm64 2>/dev/null || echo "Provider already exists"
          vagrant cloud provider upload dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} vmware_desktop \
            arm64 boxes/ubuntu-24.04-vmware-arm64.box

      - name: Add VirtualBox Provider (Existing Version)
        if: needs.build-virtualbox-arm64.result == 'success' && steps.check_version.outputs.exists == 'true'
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          vagrant cloud provider create dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} virtualbox \
            --architecture arm64 2>/dev/null || echo "Provider already exists"
          vagrant cloud provider upload dasomel/ubuntu-24.04 ${{ steps.version.outputs.version }} virtualbox \
            arm64 boxes/ubuntu-24.04-virtualbox-arm64.box
