name: Upgrade AMD64 Box to 0.1.1

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  upgrade-virtualbox:
    name: Upgrade VirtualBox AMD64 to 0.1.1
    runs-on: ubuntu-latest
    timeout-minutes: 60
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install VirtualBox
        run: |
          wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add -
          echo "deb [arch=amd64] https://download.virtualbox.org/virtualbox/debian $(lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list
          sudo apt-get update
          sudo apt-get install -y virtualbox-7.0
          VBoxManage --version

      - name: Setup Vagrant
        run: |
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update
          sudo apt-get install -y vagrant

      - name: Download 0.1.0 Box
        run: |
          mkdir -p work
          cd work
          cat > Vagrantfile << 'EOF'
          Vagrant.configure("2") do |config|
            config.vm.box = "dasomel/ubuntu-24.04"
            config.vm.box_version = "0.1.0"
            config.vm.provider "virtualbox" do |vb|
              vb.memory = "2048"
              vb.cpus = 2
            end
          end
          EOF
          vagrant box add dasomel/ubuntu-24.04 --box-version 0.1.0 --provider virtualbox

      - name: Create Upgrade Script
        run: |
          cat > work/apply-0.1.1-changes.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          export DEBIAN_FRONTEND=noninteractive

          echo "=== Applying 0.1.1 changes ==="

          # Switch to Korean mirror
          echo "Switching to Korean mirror..."
          ARCH=$(dpkg --print-architecture)
          if [ "$ARCH" = "amd64" ]; then
            sudo sed -i 's|archive.ubuntu.com|kr.archive.ubuntu.com|g' /etc/apt/sources.list.d/ubuntu.sources
            sudo sed -i 's|security.ubuntu.com|kr.archive.ubuntu.com|g' /etc/apt/sources.list.d/ubuntu.sources
            echo "  -> AMD64: Using kr.archive.ubuntu.com"
          fi

          # Set Korean timezone
          echo "Setting timezone to Asia/Seoul (KST)..."
          sudo timedatectl set-timezone Asia/Seoul
          echo "  -> Timezone: $(timedatectl show --property=Timezone --value)"

          # Configure Korean NTP servers
          echo "Configuring Korean NTP servers..."
          sudo mkdir -p /etc/systemd/timesyncd.conf.d
          sudo tee /etc/systemd/timesyncd.conf.d/kr-ntp.conf > /dev/null <<EOF
          [Time]
          NTP=time.bora.net time.kriss.re.kr ntp.kornet.net
          FallbackNTP=ntp.ubuntu.com
          EOF
          sudo systemctl restart systemd-timesyncd
          echo "  -> NTP servers configured"

          # Test new mirror
          echo "Testing new mirror..."
          sudo apt-get update

          # Cleanup
          echo "Cleaning up..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          sudo rm -rf /tmp/*
          sudo rm -f /var/log/*.log
          history -c

          echo "=== 0.1.1 changes applied successfully ==="
          SCRIPT
          chmod +x work/apply-0.1.1-changes.sh

      - name: Start VM and Apply Changes
        run: |
          cd work
          vagrant up
          vagrant ssh -c "cat /tmp/apply-changes.sh" < apply-0.1.1-changes.sh || true
          cat apply-0.1.1-changes.sh | vagrant ssh -- 'cat > /tmp/apply-changes.sh && chmod +x /tmp/apply-changes.sh && sudo /tmp/apply-changes.sh'

      - name: Verify Changes
        run: |
          cd work
          vagrant ssh -- 'echo "=== Timezone ===" && timedatectl show --property=Timezone --value && echo "" && echo "=== APT Mirror ===" && grep -E "archive.ubuntu.com" /etc/apt/sources.list.d/ubuntu.sources | head -2 && echo "" && echo "=== NTP ===" && cat /etc/systemd/timesyncd.conf.d/kr-ntp.conf'

      - name: Package Box
        run: |
          cd work
          vagrant halt
          vagrant package --output ubuntu-24.04-virtualbox-amd64-0.1.1.box
          ls -lh ubuntu-24.04-virtualbox-amd64-0.1.1.box

      - name: Upload to Vagrant Cloud
        env:
          VAGRANT_CLOUD_TOKEN: ${{ secrets.VAGRANT_CLOUD_TOKEN }}
        run: |
          cd work
          # Create provider (correct argument order: box version provider --architecture)
          vagrant cloud provider create dasomel/ubuntu-24.04 0.1.1 virtualbox \
            --architecture amd64 2>/dev/null || echo "Provider already exists"

          # Upload box (correct argument order: box version provider architecture file)
          vagrant cloud provider upload dasomel/ubuntu-24.04 0.1.1 virtualbox \
            amd64 ubuntu-24.04-virtualbox-amd64-0.1.1.box

      - name: Cleanup
        if: always()
        run: |
          cd work
          vagrant destroy -f || true
          vagrant box remove dasomel/ubuntu-24.04 --all -f || true
          rm -rf work
